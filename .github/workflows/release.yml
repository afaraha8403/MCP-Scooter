# ==============================================================================
# MCP Scooter Release Workflow
# ==============================================================================
#
# This workflow builds the Go backend and Tauri desktop app for Windows, macOS,
# and Linux, then creates a GitHub Release with all artifacts.
#
# TRIGGER:
#   - Push of version tags (v*)
#   - Manual dispatch with version input
#
# RELEASE CHANNELS:
#   - Stable: Tags like v1.0.0, v1.2.3
#   - Beta:   Tags like v1.0.0-beta.1, v1.0.0-alpha.2, v1.0.0-rc.1
#
# REQUIRED GITHUB SECRETS (must be configured before running this workflow):
# ┌──────────────────────────────────────┬─────────────────────────────────────┐
# │ Secret Name                          │ Description                         │
# ├──────────────────────────────────────┼─────────────────────────────────────┤
# │ TAURI_SIGNING_PRIVATE_KEY            │ Private key for signing updates.    │
# │                                      │ Generate with:                      │
# │                                      │ `npm run tauri signer generate`     │
# │                                      │ Store the PRIVATE key content here. │
# ├──────────────────────────────────────┼─────────────────────────────────────┤
# │ TAURI_SIGNING_PRIVATE_KEY_PASSWORD   │ Password for the private key.       │
# │                                      │ Set during key generation.          │
# │                                      │ Can be empty if no password was set.│
# └──────────────────────────────────────┴─────────────────────────────────────┘
#
# SETUP INSTRUCTIONS:
#   1. Generate signing keys locally:
#      cd desktop && npm run tauri signer generate -- -w ~/.tauri/mcp-scooter.key
#
#   2. Copy the PUBLIC key (from ~/.tauri/mcp-scooter.key.pub) to:
#      desktop/src-tauri/tauri.conf.json -> plugins.updater.pubkey
#
#   3. Add GitHub secrets (Settings > Secrets > Actions):
#      - TAURI_SIGNING_PRIVATE_KEY: Content of ~/.tauri/mcp-scooter.key
#      - TAURI_SIGNING_PRIVATE_KEY_PASSWORD: Your key password
#
#   4. Run: ./tasks.ps1 release <version>
#
# ==============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.0.1 or 0.0.1-beta.1)'
        required: true
        default: '0.0.1'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Job 1: Run Tests
  # ============================================================================
  # Ensures code quality before building release artifacts.
  # This job runs on Ubuntu for speed and validates:
  #   - All Go unit tests pass
  #   - Registry JSON files are valid
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Run Go tests
        run: go test ./...
      
      - name: Validate registry
        run: |
          go build -o validate-registry ./cmd/validate-registry
          ./validate-registry appdata/registry

  # ============================================================================
  # Job 2: Build & Release
  # ============================================================================
  # Builds platform-specific installers using Tauri.
  #
  # MATRIX STRATEGY:
  #   - Windows:     x86_64 (amd64)
  #   - macOS:       x86_64 (Intel) and aarch64 (Apple Silicon M1+)
  #   - Linux:       x86_64 (amd64) on Ubuntu 22.04
  #
  # EXTERNAL BINARY (SIDECAR):
  #   Tauri bundles the Go backend as an "external binary" (sidecar).
  #   The binary MUST be named with the target triple suffix:
  #     - scooter-x86_64-pc-windows-msvc.exe    (Windows)
  #     - scooter-x86_64-apple-darwin           (macOS Intel)
  #     - scooter-aarch64-apple-darwin          (macOS Apple Silicon)
  #     - scooter-x86_64-unknown-linux-gnu      (Linux)
  #
  #   This naming convention is REQUIRED by Tauri's externalBin feature.
  #   See: https://v2.tauri.app/develop/sidecar/
  #
  # UPDATER SIGNING:
  #   The updater requires cryptographic signatures to verify update integrity.
  #   TAURI_SIGNING_PRIVATE_KEY must be set as a GitHub secret.
  #   See workflow header for setup instructions.
  # ============================================================================
  release:
    name: Build & Release (${{ matrix.settings.platform }})
    needs: test
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        settings:
          # ---- Windows x86_64 ----
          - platform: windows-latest
            go_os: windows
            go_arch: amd64
            binary_ext: .exe
            target_triple: x86_64-pc-windows-msvc
            args: ''
          
          # ---- macOS Intel (x86_64) ----
          - platform: macos-latest
            go_os: darwin
            go_arch: amd64
            binary_ext: ''
            target_triple: x86_64-apple-darwin
            args: '--target x86_64-apple-darwin'
          
          # ---- macOS Apple Silicon (aarch64) ----
          - platform: macos-latest
            go_os: darwin
            go_arch: arm64
            binary_ext: ''
            target_triple: aarch64-apple-darwin
            args: '--target aarch64-apple-darwin'
          
          # ---- Linux x86_64 ----
          - platform: ubuntu-22.04
            go_os: linux
            go_arch: amd64
            binary_ext: ''
            target_triple: x86_64-unknown-linux-gnu
            args: ''

    runs-on: ${{ matrix.settings.platform }}
    
    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # Step: Determine Release Channel
      # ------------------------------------------------------------------------
      # Parses the git tag to determine if this is a stable or beta release.
      # Beta releases include: -alpha.X, -beta.X, -rc.X suffixes
      # ------------------------------------------------------------------------
      - name: Determine release channel
        id: channel
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ "$TAG" =~ -(alpha|beta|rc)\. ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "channel=beta" >> $GITHUB_OUTPUT
            echo "Release channel: BETA"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "channel=stable" >> $GITHUB_OUTPUT
            echo "Release channel: STABLE"
          fi

      # ------------------------------------------------------------------------
      # Step: Setup Node.js
      # ------------------------------------------------------------------------
      # Required for building the React frontend and running Tauri CLI.
      # ------------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ------------------------------------------------------------------------
      # Step: Setup Go
      # ------------------------------------------------------------------------
      # Required for building the scooter backend binary.
      # ------------------------------------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # ------------------------------------------------------------------------
      # Step: Setup Rust
      # ------------------------------------------------------------------------
      # Required for compiling the Tauri application shell.
      # On macOS, we need both Intel and Apple Silicon targets for universal builds.
      # ------------------------------------------------------------------------
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      # ------------------------------------------------------------------------
      # Step: Rust Cache
      # ------------------------------------------------------------------------
      # Caches Cargo registry, index, and build artifacts to speed up builds.
      # Without this, each build would recompile all Rust dependencies (~10 min).
      # The workspaces path must point to the Tauri project's src-tauri folder.
      # ------------------------------------------------------------------------
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './desktop/src-tauri -> target'

      # ------------------------------------------------------------------------
      # Step: Install Linux Dependencies
      # ------------------------------------------------------------------------
      # Tauri on Linux requires system libraries for WebKit, AppIndicator, etc.
      # These are NOT needed on Windows/macOS (they use native WebView).
      # ------------------------------------------------------------------------
      - name: Install Linux dependencies
        if: matrix.settings.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      # ------------------------------------------------------------------------
      # Step: Build Go Backend (Sidecar)
      # ------------------------------------------------------------------------
      # Compiles the Go backend binary that Tauri will bundle as a sidecar.
      #
      # CRITICAL: The binary MUST be named with the target triple suffix!
      #   Format: scooter-{TARGET_TRIPLE}{EXT}
      #   Example: scooter-x86_64-pc-windows-msvc.exe
      #
      # This naming convention is required by Tauri's externalBin feature.
      # The tauri.conf.json specifies "binaries/scooter" and Tauri automatically
      # appends the appropriate target triple based on the build target.
      # ------------------------------------------------------------------------
      - name: Build Go Backend
        env:
          GOOS: ${{ matrix.settings.go_os }}
          GOARCH: ${{ matrix.settings.go_arch }}
          CGO_ENABLED: 0
        shell: bash
        run: |
          # Ensure binaries directory exists (remove if it's accidentally a file)
          if [ -f desktop/src-tauri/binaries ]; then
            rm desktop/src-tauri/binaries
          fi
          mkdir -p desktop/src-tauri/binaries
          
          # Build with target triple suffix (REQUIRED by Tauri sidecar)
          go build -ldflags="-s -w" -o desktop/src-tauri/binaries/scooter-${{ matrix.settings.target_triple }}${{ matrix.settings.binary_ext }} ./cmd/scooter

      # ------------------------------------------------------------------------
      # Step: Install Frontend Dependencies
      # ------------------------------------------------------------------------
      # Installs npm packages for the React frontend.
      # Using `npm ci` for reproducible builds from package-lock.json.
      # ------------------------------------------------------------------------
      - name: Install frontend dependencies
        working-directory: desktop
        run: npm ci

      # ------------------------------------------------------------------------
      # Step: Build Tauri App & Create Release
      # ------------------------------------------------------------------------
      # Uses the official tauri-action to:
      #   1. Build the Tauri desktop application
      #   2. Sign update artifacts (requires TAURI_SIGNING_PRIVATE_KEY)
      #   3. Create/update GitHub release with artifacts
      #   4. Generate updater JSON manifest
      #
      # ENVIRONMENT VARIABLES:
      #   - GITHUB_TOKEN: Required for creating releases (auto-provided)
      #   - TAURI_SIGNING_PRIVATE_KEY: Required for signing updates
      #   - TAURI_SIGNING_PRIVATE_KEY_PASSWORD: Password for the signing key
      #
      # If TAURI_SIGNING_PRIVATE_KEY is not set, the build will FAIL with:
      #   "Error incorrect updater private key password" or similar.
      #
      # See workflow header for setup instructions.
      # ------------------------------------------------------------------------
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Updater signing keys - MUST be configured as GitHub secrets
          # Generate with: npm run tauri signer generate -- -w ~/.tauri/mcp-scooter.key
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: desktop
          tagName: v__VERSION__
          releaseName: 'MCP Scooter v__VERSION__'
          releaseBody: |
            ## MCP Scooter v__VERSION__
            
            ${{ steps.channel.outputs.is_prerelease == 'true' && '⚠️ **This is a beta release.** It may contain bugs and is not recommended for production use.' || '✅ **This is a stable release.**' }}
            
            ### Installation
            
            Download the appropriate installer for your platform:
            - **Windows**: `.msi` or `.exe` installer
            - **macOS**: `.dmg` disk image
            - **Linux**: `.deb` or `.AppImage`
            
            ### What's New
            
            See [CHANGELOG.md](https://github.com/mcp-scooter/scooter/blob/main/CHANGELOG.md) for details.
            
            ### Getting Started
            
            1. Install MCP Scooter
            2. Launch the app (it will appear in your system tray)
            3. Configure your AI client (Cursor, Claude, VS Code, etc.) to connect to `http://127.0.0.1:6277/sse`
            
            For detailed instructions, visit our [documentation](https://mcp-scooter.com).
          releaseDraft: true
          prerelease: ${{ steps.channel.outputs.is_prerelease }}
          # Upload the updater JSON manifest (latest.json) for auto-updates
          # This requires TAURI_SIGNING_PRIVATE_KEY to be set
          uploadUpdaterJson: true
          args: ${{ matrix.settings.args }}

  # ============================================================================
  # Job 3: Update Updater Manifests
  # ============================================================================
  # After all platform builds complete, this job consolidates the updater
  # JSON files for the auto-update system.
  #
  # UPDATER CHANNELS:
  #   - latest.json: Points to the latest stable OR beta release
  #   - beta.json:   Points to the latest beta release only
  #
  # Stable users only receive stable updates (check latest.json).
  # Beta users receive both stable and beta updates (check beta.json).
  # ============================================================================
  update-updater-json:
    name: Update Updater Manifests
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine release channel
        id: channel
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ "$TAG" =~ -(alpha|beta|rc)\. ]]; then
            echo "channel=beta" >> $GITHUB_OUTPUT
          else
            echo "channel=stable" >> $GITHUB_OUTPUT
          fi
      
      - name: Download release artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          mkdir -p updater-files
          
          # Download the updater JSON that tauri-action created
          gh release download "$TAG" --pattern "latest.json" --dir updater-files || true
          
          # Log the downloaded file for debugging
          if [ -f "updater-files/latest.json" ]; then
            echo "Found updater JSON from release"
            cat updater-files/latest.json
          fi
      
      - name: Update channel-specific updater file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          CHANNEL="${{ steps.channel.outputs.channel }}"
          
          # Create or update the special "updater" release that holds manifest files
          # This release is used by the app to check for updates
          if ! gh release view updater &>/dev/null; then
            gh release create updater --title "Updater Manifests" --notes "This release contains updater manifest files. Do not delete." --prerelease
          fi
          
          # Copy the updater JSON to the appropriate channel file
          if [ -f "updater-files/latest.json" ]; then
            if [ "$CHANNEL" = "beta" ]; then
              # For beta: update both beta.json AND latest.json (beta users get all updates)
              cp updater-files/latest.json updater-files/beta.json
              gh release upload updater updater-files/beta.json --clobber
              gh release upload updater updater-files/latest.json --clobber
              echo "Updated beta.json and latest.json for beta release"
            else
              # For stable: update only latest.json (stable users only get stable)
              gh release upload updater updater-files/latest.json --clobber
              echo "Updated latest.json for stable release"
            fi
          fi
